package deduplicator;

import org.apache.kafka.common.serialization.Serdes;
import org.apache.kafka.streams.KeyValue;
import org.apache.kafka.streams.TestInputTopic;
import org.apache.kafka.streams.TestOutputTopic;
import org.apache.kafka.streams.Topology;
import org.apache.kafka.streams.TopologyTestDriver;
import org.junit.Test;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;

import us.dot.its.jpo.deduplicator.deduplicator.topologies.TimDeduplicatorTopology;
import static org.junit.jupiter.api.Assertions.assertEquals;

import java.util.List;


public class TimDeduplicatorTopologyTest {

    String inputTopic = "topic.OdeTimJson";
    String outputTopic = "topic.DeduplicatedOdeTimJson";

    ObjectMapper objectMapper = new ObjectMapper();

    // String inputTim1 = "{\"metadata\": {\"request\": {\"ode\": {\"verb\": \"POST\", \"version\": \"3\"}, \"sdw\": {\"recordId\": \"8F1EC79A\", \"serviceRegion\": {\"nwCorner\": {\"latitude\": \"38.260071253000035\", \"longitude\": \"-104.61205821899995\"}, \"seCorner\": {\"latitude\": \"38.24662288300004\", \"longitude\": \"-104.60519522999999\"}}, \"ttl\": \"oneday\"}}, \"recordGeneratedBy\": \"TMC\", \"schemaVersion\": \"6\", \"payloadType\": \"us.dot.its.jpo.ode.model.OdeTimPayload\", \"odePacketID\": \"2BDF1FF7CC704D162F\", \"serialId\": {\"recordId\": \"0\", \"serialNumber\": \"5368\", \"streamId\": \"b0b6d9d1-b141-4c36-8e6c-399b0d3752cb\", \"bundleSize\": \"1\", \"bundleId\": \"5368\"}, \"sanitized\": \"false\", \"recordGeneratedAt\": \"2024-02-06T16:05:07Z\", \"maxDurationTime\": \"30\", \"odeTimStartDateTime\": \"2024-02-07T03:30:35.594Z\", \"odeReceivedAt\": \"2024-02-07T03:30:36.655175608Z\"}, \"payload\": {\"data\": {\"AdvisorySituationData\": {\"recordID\": \"8F1EC79A\", \"timeToLive\": \"2\", \"serviceRegion\": {\"nwCorner\": {\"lat\": \"382600713\", \"long\": \"-1046120582\"}, \"seCorner\": {\"lat\": \"382466229\", \"long\": \"-1046051952\"}}, \"asdmDetails\": {\"advisoryMessage\": {\"Ieee1609Dot2Data\": {\"protocolVersion\": \"3\", \"content\": {\"unsecuredData\": {\"MessageFrame\": {\"messageId\": \"31\", \"value\": {\"TravelerInformation\": {\"timeStamp\": \"52805\", \"packetID\": \"2BDF1FF7CC704D162F\", \"urlB\": \"null\", \"dataFrames\": {\"TravelerDataFrame\": {\"durationTime\": \"30\", \"regions\": {\"GeographicalPath\": {\"closedPath\": {\"false\": \"\"}, \"anchor\": {\"lat\": \"382464880\", \"long\": \"-1046120566\"}, \"name\": \"I_I-25_SAT_8F1EC79A\", \"laneWidth\": \"5000\", \"directionality\": {\"both\": \"\"}, \"description\": {\"path\": {\"offset\": {\"ll\": {\"nodes\": {\"NodeLL\": [{\"delta\": {\"node-LL1\": {\"lon\": \"-10\", \"lat\": \"1349\"}}}, {\"delta\": {\"node-LL1\": {\"lon\": \"-6\", \"lat\": \"867\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"508\", \"lat\": \"7000\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1661\", \"lat\": \"4937\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"4782\", \"lat\": \"7303\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"10822\", \"lat\": \"13477\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"2959\", \"lat\": \"5342\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1727\", \"lat\": \"5691\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"478\", \"lat\": \"5229\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"813\", \"lat\": \"9717\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1340\", \"lat\": \"4096\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"2129\", \"lat\": \"4303\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"4414\", \"lat\": \"5808\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"9105\", \"lat\": \"10079\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"11527\", \"lat\": \"13142\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"7811\", \"lat\": \"8931\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"3534\", \"lat\": \"5332\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1496\", \"lat\": \"3910\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1336\", \"lat\": \"3608\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1151\", \"lat\": \"4104\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"870\", \"lat\": \"7091\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"166\", \"lat\": \"4518\"}}}]}}}, \"scale\": \"0\"}}, \"id\": {\"id\": \"0\", \"region\": \"0\"}, \"direction\": \"1100000000000001\"}}, \"startYear\": \"2024\", \"notUsed2\": \"0\", \"msgId\": {\"roadSignID\": {\"viewAngle\": \"1111111111111111\", \"mutcdCode\": {\"warning\": \"\"}, \"position\": {\"lat\": \"382464880\", \"long\": \"-1046120566\"}}}, \"notUsed3\": \"0\", \"notUsed1\": \"0\", \"priority\": \"5\", \"content\": {\"workZone\": {\"SEQUENCE\": {\"item\": {\"itis\": \"1025\"}}}}, \"url\": \"null\", \"notUsed\": \"0\", \"frameType\": {\"advisory\": \"\"}, \"startTime\": \"53490\"}}, \"msgCnt\": \"1\"}}}}}}}, \"startTime\": {\"month\": \"0\", \"hour\": \"31\", \"year\": \"0\", \"day\": \"0\", \"minute\": \"60\"}, \"stopTime\": {\"month\": \"0\", \"hour\": \"31\", \"year\": \"0\", \"day\": \"0\", \"minute\": \"60\"}, \"distType\": \"02\", \"asdmType\": \"2\", \"asdmID\": \"17B500B3\"}, \"requestID\": \"17B500B3\", \"groupID\": \"00000000\", \"dialogID\": \"156\", \"seqID\": \"5\"}}, \"dataType\": \"TravelerInformation\"}, \"recordGeneratedAt\": {\"$date\": \"2024-02-07T03:30:36.655Z\"}}";
    // String inputTim2 = "{\"metadata\": {\"request\": {\"ode\": {\"verb\": \"POST\", \"version\": \"3\"}, \"sdw\": {\"recordId\": \"8F1EC79A\", \"serviceRegion\": {\"nwCorner\": {\"latitude\": \"38.260071253000035\", \"longitude\": \"-104.61205821899995\"}, \"seCorner\": {\"latitude\": \"38.24662288300004\", \"longitude\": \"-104.60519522999999\"}}, \"ttl\": \"oneday\"}}, \"recordGeneratedBy\": \"TMC\", \"schemaVersion\": \"6\", \"payloadType\": \"us.dot.its.jpo.ode.model.OdeTimPayload\", \"odePacketID\": \"2BDF1FF7CC704D162F\", \"serialId\": {\"recordId\": \"0\", \"serialNumber\": \"5368\", \"streamId\": \"b0b6d9d1-b141-4c36-8e6c-399b0d3752cb\", \"bundleSize\": \"1\", \"bundleId\": \"5368\"}, \"sanitized\": \"false\", \"recordGeneratedAt\": \"2024-02-06T16:05:07Z\", \"maxDurationTime\": \"30\", \"odeTimStartDateTime\": \"2024-02-07T03:30:35.594Z\", \"odeReceivedAt\": \"2024-02-07T03:30:37.655175608Z\"}, \"payload\": {\"data\": {\"AdvisorySituationData\": {\"recordID\": \"8F1EC79A\", \"timeToLive\": \"2\", \"serviceRegion\": {\"nwCorner\": {\"lat\": \"382600713\", \"long\": \"-1046120582\"}, \"seCorner\": {\"lat\": \"382466229\", \"long\": \"-1046051952\"}}, \"asdmDetails\": {\"advisoryMessage\": {\"Ieee1609Dot2Data\": {\"protocolVersion\": \"3\", \"content\": {\"unsecuredData\": {\"MessageFrame\": {\"messageId\": \"31\", \"value\": {\"TravelerInformation\": {\"timeStamp\": \"52805\", \"packetID\": \"2BDF1FF7CC704D162F\", \"urlB\": \"null\", \"dataFrames\": {\"TravelerDataFrame\": {\"durationTime\": \"30\", \"regions\": {\"GeographicalPath\": {\"closedPath\": {\"false\": \"\"}, \"anchor\": {\"lat\": \"382464880\", \"long\": \"-1046120566\"}, \"name\": \"I_I-25_SAT_8F1EC79A\", \"laneWidth\": \"5000\", \"directionality\": {\"both\": \"\"}, \"description\": {\"path\": {\"offset\": {\"ll\": {\"nodes\": {\"NodeLL\": [{\"delta\": {\"node-LL1\": {\"lon\": \"-10\", \"lat\": \"1349\"}}}, {\"delta\": {\"node-LL1\": {\"lon\": \"-6\", \"lat\": \"867\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"508\", \"lat\": \"7000\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1661\", \"lat\": \"4937\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"4782\", \"lat\": \"7303\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"10822\", \"lat\": \"13477\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"2959\", \"lat\": \"5342\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1727\", \"lat\": \"5691\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"478\", \"lat\": \"5229\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"813\", \"lat\": \"9717\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1340\", \"lat\": \"4096\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"2129\", \"lat\": \"4303\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"4414\", \"lat\": \"5808\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"9105\", \"lat\": \"10079\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"11527\", \"lat\": \"13142\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"7811\", \"lat\": \"8931\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"3534\", \"lat\": \"5332\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1496\", \"lat\": \"3910\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1336\", \"lat\": \"3608\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1151\", \"lat\": \"4104\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"870\", \"lat\": \"7091\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"166\", \"lat\": \"4518\"}}}]}}}, \"scale\": \"0\"}}, \"id\": {\"id\": \"0\", \"region\": \"0\"}, \"direction\": \"1100000000000001\"}}, \"startYear\": \"2024\", \"notUsed2\": \"0\", \"msgId\": {\"roadSignID\": {\"viewAngle\": \"1111111111111111\", \"mutcdCode\": {\"warning\": \"\"}, \"position\": {\"lat\": \"382464880\", \"long\": \"-1046120566\"}}}, \"notUsed3\": \"0\", \"notUsed1\": \"0\", \"priority\": \"5\", \"content\": {\"workZone\": {\"SEQUENCE\": {\"item\": {\"itis\": \"1025\"}}}}, \"url\": \"null\", \"notUsed\": \"0\", \"frameType\": {\"advisory\": \"\"}, \"startTime\": \"53490\"}}, \"msgCnt\": \"1\"}}}}}}}, \"startTime\": {\"month\": \"0\", \"hour\": \"31\", \"year\": \"0\", \"day\": \"0\", \"minute\": \"60\"}, \"stopTime\": {\"month\": \"0\", \"hour\": \"31\", \"year\": \"0\", \"day\": \"0\", \"minute\": \"60\"}, \"distType\": \"02\", \"asdmType\": \"2\", \"asdmID\": \"17B500B3\"}, \"requestID\": \"17B500B3\", \"groupID\": \"00000000\", \"dialogID\": \"156\", \"seqID\": \"5\"}}, \"dataType\": \"TravelerInformation\"}, \"recordGeneratedAt\": {\"$date\": \"2024-02-07T03:30:36.655Z\"}}";
    // String inputTim3 = "{\"metadata\": {\"request\": {\"ode\": {\"verb\": \"POST\", \"version\": \"3\"}, \"sdw\": {\"recordId\": \"8F1EC79A\", \"serviceRegion\": {\"nwCorner\": {\"latitude\": \"38.260071253000035\", \"longitude\": \"-104.61205821899995\"}, \"seCorner\": {\"latitude\": \"38.24662288300004\", \"longitude\": \"-104.60519522999999\"}}, \"ttl\": \"oneday\"}}, \"recordGeneratedBy\": \"TMC\", \"schemaVersion\": \"6\", \"payloadType\": \"us.dot.its.jpo.ode.model.OdeTimPayload\", \"odePacketID\": \"2BDF1FF7CC704D162F\", \"serialId\": {\"recordId\": \"0\", \"serialNumber\": \"5368\", \"streamId\": \"b0b6d9d1-b141-4c36-8e6c-399b0d3752cb\", \"bundleSize\": \"1\", \"bundleId\": \"5368\"}, \"sanitized\": \"false\", \"recordGeneratedAt\": \"2024-02-06T16:05:07Z\", \"maxDurationTime\": \"30\", \"odeTimStartDateTime\": \"2024-02-07T03:30:35.594Z\", \"odeReceivedAt\": \"2024-02-07T03:30:38.655175608Z\"}, \"payload\": {\"data\": {\"AdvisorySituationData\": {\"recordID\": \"8F1EC79A\", \"timeToLive\": \"2\", \"serviceRegion\": {\"nwCorner\": {\"lat\": \"382600713\", \"long\": \"-1046120582\"}, \"seCorner\": {\"lat\": \"382466229\", \"long\": \"-1046051952\"}}, \"asdmDetails\": {\"advisoryMessage\": {\"Ieee1609Dot2Data\": {\"protocolVersion\": \"3\", \"content\": {\"unsecuredData\": {\"MessageFrame\": {\"messageId\": \"31\", \"value\": {\"TravelerInformation\": {\"timeStamp\": \"52805\", \"packetID\": \"2BDF1FF7CC704D162A\", \"urlB\": \"null\", \"dataFrames\": {\"TravelerDataFrame\": {\"durationTime\": \"30\", \"regions\": {\"GeographicalPath\": {\"closedPath\": {\"false\": \"\"}, \"anchor\": {\"lat\": \"382464880\", \"long\": \"-1046120566\"}, \"name\": \"I_I-25_SAT_8F1EC79A\", \"laneWidth\": \"5000\", \"directionality\": {\"both\": \"\"}, \"description\": {\"path\": {\"offset\": {\"ll\": {\"nodes\": {\"NodeLL\": [{\"delta\": {\"node-LL1\": {\"lon\": \"-10\", \"lat\": \"1349\"}}}, {\"delta\": {\"node-LL1\": {\"lon\": \"-6\", \"lat\": \"867\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"508\", \"lat\": \"7000\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1661\", \"lat\": \"4937\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"4782\", \"lat\": \"7303\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"10822\", \"lat\": \"13477\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"2959\", \"lat\": \"5342\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1727\", \"lat\": \"5691\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"478\", \"lat\": \"5229\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"813\", \"lat\": \"9717\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1340\", \"lat\": \"4096\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"2129\", \"lat\": \"4303\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"4414\", \"lat\": \"5808\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"9105\", \"lat\": \"10079\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"11527\", \"lat\": \"13142\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"7811\", \"lat\": \"8931\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"3534\", \"lat\": \"5332\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1496\", \"lat\": \"3910\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1336\", \"lat\": \"3608\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1151\", \"lat\": \"4104\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"870\", \"lat\": \"7091\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"166\", \"lat\": \"4518\"}}}]}}}, \"scale\": \"0\"}}, \"id\": {\"id\": \"0\", \"region\": \"0\"}, \"direction\": \"1100000000000001\"}}, \"startYear\": \"2024\", \"notUsed2\": \"0\", \"msgId\": {\"roadSignID\": {\"viewAngle\": \"1111111111111111\", \"mutcdCode\": {\"warning\": \"\"}, \"position\": {\"lat\": \"382464880\", \"long\": \"-1046120566\"}}}, \"notUsed3\": \"0\", \"notUsed1\": \"0\", \"priority\": \"5\", \"content\": {\"workZone\": {\"SEQUENCE\": {\"item\": {\"itis\": \"1025\"}}}}, \"url\": \"null\", \"notUsed\": \"0\", \"frameType\": {\"advisory\": \"\"}, \"startTime\": \"53490\"}}, \"msgCnt\": \"1\"}}}}}}}, \"startTime\": {\"month\": \"0\", \"hour\": \"31\", \"year\": \"0\", \"day\": \"0\", \"minute\": \"60\"}, \"stopTime\": {\"month\": \"0\", \"hour\": \"31\", \"year\": \"0\", \"day\": \"0\", \"minute\": \"60\"}, \"distType\": \"02\", \"asdmType\": \"2\", \"asdmID\": \"17B500B3\"}, \"requestID\": \"17B500B3\", \"groupID\": \"00000000\", \"dialogID\": \"156\", \"seqID\": \"5\"}}, \"dataType\": \"TravelerInformation\"}, \"recordGeneratedAt\": {\"$date\": \"2024-02-07T03:30:36.655Z\"}}";
    // String inputTim4 = "{\"metadata\": {\"request\": {\"ode\": {\"verb\": \"POST\", \"version\": \"3\"}, \"sdw\": {\"recordId\": \"8F1EC79A\", \"serviceRegion\": {\"nwCorner\": {\"latitude\": \"38.260071253000035\", \"longitude\": \"-104.61205821899995\"}, \"seCorner\": {\"latitude\": \"38.24662288300004\", \"longitude\": \"-104.60519522999999\"}}, \"ttl\": \"oneday\"}}, \"recordGeneratedBy\": \"TMC\", \"schemaVersion\": \"6\", \"payloadType\": \"us.dot.its.jpo.ode.model.OdeTimPayload\", \"odePacketID\": \"2BDF1FF7CC704D162F\", \"serialId\": {\"recordId\": \"0\", \"serialNumber\": \"5368\", \"streamId\": \"b0b6d9d1-b141-4c36-8e6c-399b0d3752cb\", \"bundleSize\": \"1\", \"bundleId\": \"5368\"}, \"sanitized\": \"false\", \"recordGeneratedAt\": \"2024-02-06T16:05:07Z\", \"maxDurationTime\": \"30\", \"odeTimStartDateTime\": \"2024-02-07T03:30:35.594Z\", \"odeReceivedAt\": \"2024-02-07T04:35:36.655175608Z\"}, \"payload\": {\"data\": {\"AdvisorySituationData\": {\"recordID\": \"8F1EC79A\", \"timeToLive\": \"2\", \"serviceRegion\": {\"nwCorner\": {\"lat\": \"382600713\", \"long\": \"-1046120582\"}, \"seCorner\": {\"lat\": \"382466229\", \"long\": \"-1046051952\"}}, \"asdmDetails\": {\"advisoryMessage\": {\"Ieee1609Dot2Data\": {\"protocolVersion\": \"3\", \"content\": {\"unsecuredData\": {\"MessageFrame\": {\"messageId\": \"31\", \"value\": {\"TravelerInformation\": {\"timeStamp\": \"52805\", \"packetID\": \"2BDF1FF7CC704D162F\", \"urlB\": \"null\", \"dataFrames\": {\"TravelerDataFrame\": {\"durationTime\": \"30\", \"regions\": {\"GeographicalPath\": {\"closedPath\": {\"false\": \"\"}, \"anchor\": {\"lat\": \"382464880\", \"long\": \"-1046120566\"}, \"name\": \"I_I-25_SAT_8F1EC79A\", \"laneWidth\": \"5000\", \"directionality\": {\"both\": \"\"}, \"description\": {\"path\": {\"offset\": {\"ll\": {\"nodes\": {\"NodeLL\": [{\"delta\": {\"node-LL1\": {\"lon\": \"-10\", \"lat\": \"1349\"}}}, {\"delta\": {\"node-LL1\": {\"lon\": \"-6\", \"lat\": \"867\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"508\", \"lat\": \"7000\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1661\", \"lat\": \"4937\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"4782\", \"lat\": \"7303\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"10822\", \"lat\": \"13477\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"2959\", \"lat\": \"5342\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1727\", \"lat\": \"5691\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"478\", \"lat\": \"5229\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"813\", \"lat\": \"9717\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1340\", \"lat\": \"4096\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"2129\", \"lat\": \"4303\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"4414\", \"lat\": \"5808\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"9105\", \"lat\": \"10079\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"11527\", \"lat\": \"13142\"}}}, {\"delta\": {\"node-LL3\": {\"lon\": \"7811\", \"lat\": \"8931\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"3534\", \"lat\": \"5332\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1496\", \"lat\": \"3910\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1336\", \"lat\": \"3608\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"1151\", \"lat\": \"4104\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"870\", \"lat\": \"7091\"}}}, {\"delta\": {\"node-LL2\": {\"lon\": \"166\", \"lat\": \"4518\"}}}]}}}, \"scale\": \"0\"}}, \"id\": {\"id\": \"0\", \"region\": \"0\"}, \"direction\": \"1100000000000001\"}}, \"startYear\": \"2024\", \"notUsed2\": \"0\", \"msgId\": {\"roadSignID\": {\"viewAngle\": \"1111111111111111\", \"mutcdCode\": {\"warning\": \"\"}, \"position\": {\"lat\": \"382464880\", \"long\": \"-1046120566\"}}}, \"notUsed3\": \"0\", \"notUsed1\": \"0\", \"priority\": \"5\", \"content\": {\"workZone\": {\"SEQUENCE\": {\"item\": {\"itis\": \"1025\"}}}}, \"url\": \"null\", \"notUsed\": \"0\", \"frameType\": {\"advisory\": \"\"}, \"startTime\": \"53490\"}}, \"msgCnt\": \"1\"}}}}}}}, \"startTime\": {\"month\": \"0\", \"hour\": \"31\", \"year\": \"0\", \"day\": \"0\", \"minute\": \"60\"}, \"stopTime\": {\"month\": \"0\", \"hour\": \"31\", \"year\": \"0\", \"day\": \"0\", \"minute\": \"60\"}, \"distType\": \"02\", \"asdmType\": \"2\", \"asdmID\": \"17B500B3\"}, \"requestID\": \"17B500B3\", \"groupID\": \"00000000\", \"dialogID\": \"156\", \"seqID\": \"5\"}}, \"dataType\": \"TravelerInformation\"}, \"recordGeneratedAt\": {\"$date\": \"2024-02-07T03:30:36.655Z\"}}";


    String inputTim1 = "{\"metadata\":{\"securityResultCode\":\"success\",\"recordGeneratedBy\":\"RSU\",\"schemaVersion\":\"6\",\"odePacketID\":\"\",\"sanitized\":\"false\",\"recordType\":\"timMsg\",\"recordGeneratedAt\":\"\",\"maxDurationTime\":\"0\",\"odeTimStartDateTime\":\"\",\"receivedMessageDetails\":\"\",\"payloadType\":\"us.dot.its.jpo.ode.model.OdeTimPayload\",\"serialId\":{\"recordId\":\"0\",\"serialNumber\":\"0\",\"streamId\":\"d052115a-5289-4da3-bc9f-12edca1d2c46\",\"bundleSize\":\"1\",\"bundleId\":\"0\"},\"logFileName\":\"\",\"odeReceivedAt\":\"2024-07-23T18:33:17.328Z\",\"originIp\":\"10.16.28.54\"},\"payload\":{\"data\":{\"MessageFrame\":{\"messageId\":\"31\",\"value\":{\"TravelerInformation\":{\"timeStamp\":\"264703\",\"packetID\":\"0350C30EB1A83736D8\",\"urlB\":\"null\",\"dataFrames\":{\"TravelerDataFrame\":{\"durationTime\":\"30\",\"regions\":{\"GeographicalPath\":{\"closedPath\":{\"false\":\"\"},\"anchor\":{\"lat\":\"395658598\",\"long\":\"-1050401840\"},\"name\":\"I_CO-470_RSU_172.16.28.116\",\"laneWidth\":\"5000\",\"directionality\":{\"both\":\"\"},\"description\":{\"path\":{\"offset\":{\"ll\":{\"nodes\":{\"NodeLL\":[{\"delta\":{\"node-LL1\":{\"lon\":\"1527\",\"lat\":\"-659\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"5545\",\"lat\":\"-2394\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"9493\",\"lat\":\"-2736\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"7465\",\"lat\":\"-1304\"}}},{\"delta\":{\"node-LL4\":{\"lon\":\"34464\",\"lat\":\"-4324\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"9994\",\"lat\":\"-1119\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"20051\",\"lat\":\"-2246\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"31738\",\"lat\":\"-1775\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"5744\",\"lat\":\"-315\"}}}]}}},\"scale\":\"0\"}},\"id\":{\"id\":\"0\",\"region\":\"0\"},\"direction\":\"0000110000000000\"}},\"startYear\":\"2024\",\"notUsed2\":\"0\",\"msgId\":{\"roadSignID\":{\"viewAngle\":\"1111111111111111\",\"mutcdCode\":{\"warning\":\"\"},\"position\":{\"lat\":\"395658598\",\"long\":\"-1050401840\"}}},\"notUsed3\":\"0\",\"notUsed1\":\"0\",\"priority\":\"5\",\"content\":{\"workZone\":{\"SEQUENCE\":{\"item\":{\"itis\":\"1025\"}}}},\"url\":\"null\",\"notUsed\":\"0\",\"frameType\":{\"advisory\":\"\"},\"startTime\":\"277110\"}},\"msgCnt\":\"1\"}}}},\"dataType\":\"TravelerInformation\"}}";
    String inputTim2 = "{\"metadata\":{\"securityResultCode\":\"success\",\"recordGeneratedBy\":\"RSU\",\"schemaVersion\":\"6\",\"odePacketID\":\"\",\"sanitized\":\"false\",\"recordType\":\"timMsg\",\"recordGeneratedAt\":\"\",\"maxDurationTime\":\"0\",\"odeTimStartDateTime\":\"\",\"receivedMessageDetails\":\"\",\"payloadType\":\"us.dot.its.jpo.ode.model.OdeTimPayload\",\"serialId\":{\"recordId\":\"0\",\"serialNumber\":\"0\",\"streamId\":\"d052115a-5289-4da3-bc9f-12edca1d2c46\",\"bundleSize\":\"1\",\"bundleId\":\"0\"},\"logFileName\":\"\",\"odeReceivedAt\":\"2024-07-23T18:33:17.428Z\",\"originIp\":\"10.16.28.54\"},\"payload\":{\"data\":{\"MessageFrame\":{\"messageId\":\"31\",\"value\":{\"TravelerInformation\":{\"timeStamp\":\"264703\",\"packetID\":\"0350C30EB1A83736D8\",\"urlB\":\"null\",\"dataFrames\":{\"TravelerDataFrame\":{\"durationTime\":\"30\",\"regions\":{\"GeographicalPath\":{\"closedPath\":{\"false\":\"\"},\"anchor\":{\"lat\":\"395658598\",\"long\":\"-1050401840\"},\"name\":\"I_CO-470_RSU_172.16.28.116\",\"laneWidth\":\"5000\",\"directionality\":{\"both\":\"\"},\"description\":{\"path\":{\"offset\":{\"ll\":{\"nodes\":{\"NodeLL\":[{\"delta\":{\"node-LL1\":{\"lon\":\"1527\",\"lat\":\"-659\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"5545\",\"lat\":\"-2394\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"9493\",\"lat\":\"-2736\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"7465\",\"lat\":\"-1304\"}}},{\"delta\":{\"node-LL4\":{\"lon\":\"34464\",\"lat\":\"-4324\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"9994\",\"lat\":\"-1119\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"20051\",\"lat\":\"-2246\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"31738\",\"lat\":\"-1775\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"5744\",\"lat\":\"-315\"}}}]}}},\"scale\":\"0\"}},\"id\":{\"id\":\"0\",\"region\":\"0\"},\"direction\":\"0000110000000000\"}},\"startYear\":\"2024\",\"notUsed2\":\"0\",\"msgId\":{\"roadSignID\":{\"viewAngle\":\"1111111111111111\",\"mutcdCode\":{\"warning\":\"\"},\"position\":{\"lat\":\"395658598\",\"long\":\"-1050401840\"}}},\"notUsed3\":\"0\",\"notUsed1\":\"0\",\"priority\":\"5\",\"content\":{\"workZone\":{\"SEQUENCE\":{\"item\":{\"itis\":\"1025\"}}}},\"url\":\"null\",\"notUsed\":\"0\",\"frameType\":{\"advisory\":\"\"},\"startTime\":\"277110\"}},\"msgCnt\":\"1\"}}}},\"dataType\":\"TravelerInformation\"}}";
    String inputTim3 = "{\"metadata\":{\"securityResultCode\":\"success\",\"recordGeneratedBy\":\"RSU\",\"schemaVersion\":\"6\",\"odePacketID\":\"\",\"sanitized\":\"false\",\"recordType\":\"timMsg\",\"recordGeneratedAt\":\"\",\"maxDurationTime\":\"0\",\"odeTimStartDateTime\":\"\",\"receivedMessageDetails\":\"\",\"payloadType\":\"us.dot.its.jpo.ode.model.OdeTimPayload\",\"serialId\":{\"recordId\":\"0\",\"serialNumber\":\"0\",\"streamId\":\"d052115a-5289-4da3-bc9f-12edca1d2c46\",\"bundleSize\":\"1\",\"bundleId\":\"0\"},\"logFileName\":\"\",\"odeReceivedAt\":\"2024-07-23T19:33:17.328Z\",\"originIp\":\"10.16.28.54\"},\"payload\":{\"data\":{\"MessageFrame\":{\"messageId\":\"31\",\"value\":{\"TravelerInformation\":{\"timeStamp\":\"264703\",\"packetID\":\"0350C30EB1A83736D8\",\"urlB\":\"null\",\"dataFrames\":{\"TravelerDataFrame\":{\"durationTime\":\"30\",\"regions\":{\"GeographicalPath\":{\"closedPath\":{\"false\":\"\"},\"anchor\":{\"lat\":\"395658598\",\"long\":\"-1050401840\"},\"name\":\"I_CO-470_RSU_172.16.28.116\",\"laneWidth\":\"5000\",\"directionality\":{\"both\":\"\"},\"description\":{\"path\":{\"offset\":{\"ll\":{\"nodes\":{\"NodeLL\":[{\"delta\":{\"node-LL1\":{\"lon\":\"1527\",\"lat\":\"-659\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"5545\",\"lat\":\"-2394\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"9493\",\"lat\":\"-2736\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"7465\",\"lat\":\"-1304\"}}},{\"delta\":{\"node-LL4\":{\"lon\":\"34464\",\"lat\":\"-4324\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"9994\",\"lat\":\"-1119\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"20051\",\"lat\":\"-2246\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"31738\",\"lat\":\"-1775\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"5744\",\"lat\":\"-315\"}}}]}}},\"scale\":\"0\"}},\"id\":{\"id\":\"0\",\"region\":\"0\"},\"direction\":\"0000110000000000\"}},\"startYear\":\"2024\",\"notUsed2\":\"0\",\"msgId\":{\"roadSignID\":{\"viewAngle\":\"1111111111111111\",\"mutcdCode\":{\"warning\":\"\"},\"position\":{\"lat\":\"395658598\",\"long\":\"-1050401840\"}}},\"notUsed3\":\"0\",\"notUsed1\":\"0\",\"priority\":\"5\",\"content\":{\"workZone\":{\"SEQUENCE\":{\"item\":{\"itis\":\"1025\"}}}},\"url\":\"null\",\"notUsed\":\"0\",\"frameType\":{\"advisory\":\"\"},\"startTime\":\"277110\"}},\"msgCnt\":\"1\"}}}},\"dataType\":\"TravelerInformation\"}}";
    // String inputTim4 = "{\"metadata\":{\"securityResultCode\":\"success\",\"recordGeneratedBy\":\"RSU\",\"schemaVersion\":\"6\",\"odePacketID\":\"\",\"sanitized\":\"false\",\"recordType\":\"timMsg\",\"recordGeneratedAt\":\"\",\"maxDurationTime\":\"0\",\"odeTimStartDateTime\":\"\",\"receivedMessageDetails\":\"\",\"payloadType\":\"us.dot.its.jpo.ode.model.OdeTimPayload\",\"serialId\":{\"recordId\":\"0\",\"serialNumber\":\"0\",\"streamId\":\"d052115a-5289-4da3-bc9f-12edca1d2c46\",\"bundleSize\":\"1\",\"bundleId\":\"0\"},\"logFileName\":\"\",\"odeReceivedAt\":\"2024-07-23T19:34:17.328Z\",\"originIp\":\"10.16.28.54\"},\"payload\":{\"data\":{\"MessageFrame\":{\"messageId\":\"31\",\"value\":{\"TravelerInformation\":{\"timeStamp\":\"264703\",\"packetID\":\"0350C30EB1A83736D8\",\"urlB\":\"null\",\"dataFrames\":{\"TravelerDataFrame\":{\"durationTime\":\"30\",\"regions\":{\"GeographicalPath\":{\"closedPath\":{\"false\":\"\"},\"anchor\":{\"lat\":\"395658598\",\"long\":\"-1050401840\"},\"name\":\"I_CO-470_RSU_172.16.28.116\",\"laneWidth\":\"10000\",\"directionality\":{\"both\":\"\"},\"description\":{\"path\":{\"offset\":{\"ll\":{\"nodes\":{\"NodeLL\":[{\"delta\":{\"node-LL1\":{\"lon\":\"1527\",\"lat\":\"-659\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"5545\",\"lat\":\"-2394\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"9493\",\"lat\":\"-2736\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"7465\",\"lat\":\"-1304\"}}},{\"delta\":{\"node-LL4\":{\"lon\":\"34464\",\"lat\":\"-4324\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"9994\",\"lat\":\"-1119\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"20051\",\"lat\":\"-2246\"}}},{\"delta\":{\"node-LL3\":{\"lon\":\"31738\",\"lat\":\"-1775\"}}},{\"delta\":{\"node-LL2\":{\"lon\":\"5744\",\"lat\":\"-315\"}}}]}}},\"scale\":\"0\"}},\"id\":{\"id\":\"0\",\"region\":\"0\"},\"direction\":\"0000110000000000\"}},\"startYear\":\"2024\",\"notUsed2\":\"0\",\"msgId\":{\"roadSignID\":{\"viewAngle\":\"1111111111111111\",\"mutcdCode\":{\"warning\":\"\"},\"position\":{\"lat\":\"395658598\",\"long\":\"-1050401840\"}}},\"notUsed3\":\"0\",\"notUsed1\":\"0\",\"priority\":\"5\",\"content\":{\"workZone\":{\"SEQUENCE\":{\"item\":{\"itis\":\"1025\"}}}},\"url\":\"null\",\"notUsed\":\"0\",\"frameType\":{\"advisory\":\"\"},\"startTime\":\"277110\"}},\"msgCnt\":\"1\"}}}},\"dataType\":\"TravelerInformation\"}}";


    @Test
    public void testTopology() {

        TimDeduplicatorTopology TimDeduplicatorTopology = new TimDeduplicatorTopology(inputTopic, outputTopic, null);

        Topology topology = TimDeduplicatorTopology.buildTopology();
        objectMapper.registerModule(new JavaTimeModule());

        try (TopologyTestDriver driver = new TopologyTestDriver(topology)) {
            
            
            TestInputTopic<Void, String> inputTimData = driver.createInputTopic(
                inputTopic, 
                Serdes.Void().serializer(), 
                Serdes.String().serializer());


            TestOutputTopic<String, String> outputTimData = driver.createOutputTopic(
                outputTopic, 
                Serdes.String().deserializer(), 
                Serdes.String().deserializer());

            inputTimData.pipeInput(null, inputTim1);
            inputTimData.pipeInput(null, inputTim2);
            inputTimData.pipeInput(null, inputTim3);
            // inputTimData.pipeInput(null, inputTim4);

            List<KeyValue<String, String>> timDeduplicatedResults = outputTimData.readKeyValuesToList();

            // validate that only 3 messages make it through
            // assertEquals(3, timDeduplicatedResults.size());
            inputTim1 = inputTim1.strip();
            
            assertEquals(inputTim1.replace(" ", ""), timDeduplicatedResults.get(0).value.replace(" ", ""));
            assertEquals(inputTim3.replace(" ", ""), timDeduplicatedResults.get(1).value.replace(" ", ""));
            // assertEquals(inputTim4.replace(" ", ""), timDeduplicatedResults.get(2).value.replace(" ", ""));
        
        }catch(Exception e){
            e.printStackTrace(); 
        }
    }
}
